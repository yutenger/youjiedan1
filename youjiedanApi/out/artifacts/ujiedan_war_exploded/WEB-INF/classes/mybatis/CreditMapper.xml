<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace:命名空间 -->

<mapper namespace="com.stardai.manage.mapper.CreditMapper">

	<!-- 根据此人userId查询此人当天有没有签到 -->
	<select id="queryIsSigninByUserId" resultType="Integer">
		select
		signin_count
		from
		yjd_credit_signin_detail
		WHERE
		user_id = #{userId}
		and
		create_date = #{currentTime}
	</select>

	<!-- 获取连续签到天数对应的积分值 -->
	<select id="getValueBySigninCount" resultType="Integer">
		select
		credit_value
		from
		yjd_accumulative_signin
		WHERE
		end_day >= #{signinCount}
		order by credit_value limit 1
	</select>

	<!-- 插入当天的签到记录 -->
	<insert id="addNewSigninRecord">
		INSERT INTO
		yjd_credit_signin_detail
		(
		user_id,
		signin_credit,
		create_date,
		create_datetime,
		signin_count)
		VALUES
		(
		#{userId},
		#{signinCredit},
		now(),
		now(),
		#{signinCount})

	</insert>


	<!-- 获取此用户当前剩余的积分-->
	<select id="queryTotalCredit" resultType="Integer">
		select
		credit_value
		from
		yjd_credit_wallet
		WHERE
		user_id = #{userId}
	</select>

	<!-- 获取此用户当天获取的积分-->
	<select id="queryTodayCredit" resultType="Integer">
		select
		sum(credit_value)
		from
		yjd_credit_bill
		WHERE
		type = 2
		and create_date = substr(now(),1,10)
		and user_id = #{userId}
	</select>

	<!-- 增加或者消耗积分时，插入一条积分明细记录 -->
	<insert id="addCreditDetail">
		INSERT INTO
		yjd_credit_bill
		(
		user_id,
		credit_value,
		credit_pathway,
		credit_detail,
		type,
		create_date,
		create_datetime)
		VALUES
		(
		#{userId},
		#{creditValue},
		#{creditPathway},
		#{creditDetail},
		#{type},
		now(),
		now())

	</insert>

	<!-- 更新用户积分 -->
	<update id="updateCreditWallet">
		UPDATE yjd_credit_wallet
		SET
		credit_value = credit_value + #{creditValue},
		update_date = now()
		WHERE
		user_id = #{userId}
	</update>

	<!-- 查询积分汇总表里有没有该用户的记录-->
	<select id="queryIsEverGetCredit" resultType="Integer">
		select
		credit_value
		from
		yjd_credit_wallet
		WHERE
		user_id = #{userId}
	</select>

	<!-- 在积分汇总表插入一条新的记录 -->
	<insert id="addCreditWallet">
		INSERT INTO
		yjd_credit_wallet
		(
		user_id,
		credit_value,
		create_date)
		VALUES
		(
		#{userId},
		#{creditValue},
		now())

	</insert>
	
	<!-- 根据此人userId查询此人积分获取明细记录 -->
	<select id="getCreditDetails" resultType="com.stardai.manage.request.RequestCreditDetail">
		select
		user_id,
		credit_value,
		credit_pathway,
		type,
		create_datetime
		from
		yjd_credit_bill
		WHERE
		user_id = #{userId}
		order by create_datetime desc limit #{page},#{pageSize}
	</select>

	<!--积分兑换中心进行中的优惠券 -->
	<select id="getProcessingCouponList" resultType="com.stardai.manage.response.ResponseGetCoupon">
		select
		coupon_code,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		coupon_initial_count,
		coupon_count,
		coupon_form,
		coupon_type,
		credit_value
		from
		yjd_credit_for_coupon
		WHERE
		#{nowTime} between show_begin_time and
		show_end_time
		and #{nowTime} between get_begin_time and get_end_time
		and is_deleted = 0
		and approve_status = 0
		and coupon_count > 0
		ORDER BY
		get_begin_time,coupon_code
		
	</select>

	<!--积分兑换中心未到领取时间的优惠券 -->
	<select id="getBerforeTimeCouponList" resultType="com.stardai.manage.response.ResponseGetCoupon">
		select
		coupon_code,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		get_begin_time,
		coupon_form,
		coupon_type,
		credit_value
		from
		yjd_credit_for_coupon
		WHERE
		#{nowTime} between show_begin_time and show_end_time
		and #{nowTime}
		&lt; get_begin_time
		and is_deleted = 0
		and approve_status = 0
		ORDER BY
		get_begin_time,coupon_code
		
	</select>

	<!--积分兑换中心已经结束的优惠券 -->
	<select id="getEndCouponList" resultType="com.stardai.manage.response.ResponseGetCoupon">
		select
		coupon_code,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		coupon_form,
		coupon_type,
		credit_value
		from
		yjd_credit_for_coupon
		WHERE
		#{nowTime} between show_begin_time
		and show_end_time
		and is_deleted = 0
		and (#{nowTime} > get_end_time
		or
		approve_status = 1 
		or
		0 >= coupon_count)
		ORDER BY get_begin_time,coupon_code
		
	</select>


	<!--查询此用户抢过多少原价单 -->
	<select id="getOriginalCountByUserId" resultType="Integer">
		select
		original_count
		from
		yjd_credit_getbyoriginalprice
		WHERE
		user_id = #{userId}
		and create_time = substr(now(),1,10)
	</select>


	<!-- 插入用户抢的一条原价单记录 -->
	<insert id="insertOriginalCount">
		INSERT INTO
		yjd_credit_getbyoriginalprice
		(
		user_id,
		original_count,
		create_time)
		VALUES
		(
		#{userId},
		1,
		now())

	</insert>

	<!-- 更新用户抢的原价单数量 -->
	<update id="updateOriginalCount">
		UPDATE yjd_credit_getbyoriginalprice
		SET
		original_count = original_count + 1
		WHERE
		user_id = #{userId} and create_time = substr(now(),1,10)
	</update>

	<!-- 查看是否添加过此积分的明细（避免因为服务器延迟，添加了多条记录，所以先查后增） -->
	<select id="isAddInCreditDetail" resultType="Integer">
		select
		credit_value
		from
		yjd_credit_bill
		WHERE
		user_id = #{userId}
		and
		create_datetime = now()
		and
		credit_value = #{creditValue}
		and 
		credit_pathway = #{creditPathway}
	</select>
	
	<!-- 查这个用户之前是否浏览过此活动 -->
	<select id="isBrowseSameEvent" resultType="Integer">
		select
		event_id
		from
		yjd_user_browse_event
		WHERE
		user_id = #{userId}
		and
		event_id = #{eventId}
		
	</select>
	
	
	<!-- 查询用户更新到此版本是否获取过积分 -->
	<select id="isGetCreditByNewEdition" resultType="Integer">
		select
		id
		from
		yjd_user_update_version
		WHERE
		user_id = #{userId}
		and
		(
		version_code = #{versionCode} or ios_version = #{iosVersion}
		
		)
	</select>
	
	<!-- 用户更新版本获取积分，存到表里用作记录-->
	<insert id="addCreditByNewEdition">
		INSERT INTO
		yjd_user_update_version
		(
		user_id,
		version_code,
		ios_version,
		create_time
		)
		VALUES
		(
		#{userId},
		#{versionCode},
		#{iosVersion},
		now())

	</insert>
	
	<!-- 用户浏览活动，添加一条记录-->
	<insert id="addBrowseRecord">
		INSERT INTO
		yjd_user_browse_event
		(
		user_id,
		event_id,
		create_time
		)
		VALUES
		(
		#{userId},
		#{eventId},
		now())

	</insert>
	
	<!-- 根据标识码查询要兑换东西的剩余数量 -->
	<select id="getExchangeCountByCode" resultType="Integer">
		select
		coupon_count
		from
		yjd_credit_for_coupon
		WHERE
		coupon_code = #{couponCode}
		
	</select>
	
	<!-- 用户点击兑换，把兑换商品的数量减1 -->
	<update id="setExchangeCount">
		UPDATE yjd_credit_for_coupon
		SET
		coupon_count = coupon_count - 1
		WHERE
		coupon_code = #{couponCode}
	</update>
	
	<!-- 根据优惠券的标识查询优惠券的具体信息 -->
	<select id="getExchangeInfoByCode" resultType="com.stardai.manage.request.RequestCouponForNewUser">
		select
		credit_value,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		coupon_form,
		coupon_type,
		coupon_count,
		coupon_validity,
		effective_time,
		expiration_time,
		timing_type
		from
		yjd_credit_for_coupon
		WHERE	
		coupon_code =
		#{couponCode}
		and
		is_deleted = 0
		and
		approve_status = 0
	</select>
	
	<!-- 查看此订单跟单反馈成功是否赠送过奖励 -->
	<select id="isAddForFBSuccess" resultType="Integer">
		select
		credit_value
		from
		yjd_credit_bill
		WHERE
		user_id = #{userId}
		and
		credit_detail = #{creditDetail}
		and 
		credit_pathway = #{creditPathway}
	</select>

</mapper>