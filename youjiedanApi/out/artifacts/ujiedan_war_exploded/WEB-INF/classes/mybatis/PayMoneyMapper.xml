<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace:命名空间 -->
<mapper namespace="com.stardai.manage.mapper.PayMoneyMapper">

	<!-- 查询用户信息 -->
	<select id="queryUser" resultType="Integer">
		SELECT
		COUNT(*)
		FROM
		yjd_user_info
		WHERE
		user_id = #{userId}
		AND
		mobile_number = #{mobileNumber}
	</select>

	<!-- 设置支付密码 -->
	<insert id="addPayPd">
		INSERT INTO yjd_pay_payment (
		user_id,
		pay_pw
		)
		VALUES
		(
		#{userId},
		#{pd}
		);
	</insert>

	<!-- 修改支付密码 -->
	<update id="updatePayPd">
		UPDATE yjd_pay_payment
		SET
		pay_pw = #{pd}
		WHERE
		user_id =
		#{userId}
	</update>


	<!-- 赠送星币 -->
	<insert id="addPayPresentMessage">
		INSERT INTO yjd_pay_income (
		user_id,
		income_no,
		pay_pathway,
		pay_money,
		pay_create_time,
		type
		)
		VALUES
		(
		#{userId},
		#{incomeNo},
		#{pathWay},
		#{money},
		now(),
		#{type}
		);
	</insert>

	<!-- 首次注册赠送添加金额 -->
	<insert id="addPresentMoney">
		INSERT INTO yjd_pay_wallet (
		user_id,
		m_present
		)
		VALUES
		(
		#{userId},
		#{money}
		);
	</insert>

	<!--支出 -->
	<insert id="addOutComeMoney">
		INSERT INTO yjd_pay_outcome (
		user_id,
		order_no,
		out_no,
		channel,
		amount,
		create_time
		)
		VALUES
		(
		#{userId},
		#{orderNo},
		#{outNo},
		#{channel},
		#{amountYuan},
		now()
		);
	</insert>


	<!--根据userId查询金额 -->
	<select id="queryRechargeMoney" resultType="Integer">
		SELECT
		m_recharge
		FROM
		yjd_pay_wallet
		WHERE
		user_id = #{userId}
	</select>

	<!-- 修改金额 -->
	<update id="updateRechargeMoney">
		UPDATE yjd_pay_wallet
		SET
		m_recharge = #{amountYuan}
		WHERE
		user_id =
		#{userId}
	</update>

	<!-- 添加个人消息 -->
	<insert id="addMessage">
		INSERT INTO yjd_user_message (
		user_id,
		type,
		message_title,
		message,
		create_time
		)
		VALUES
		(
		#{userId},
		#{type},
		#{title},
		#{message},
		now()
		);
	</insert>

	<!-- 当充值金额不够修改赠送金额并设置余额为0 -->
	<update id="updatePresentUserMoney">
		UPDATE yjd_pay_wallet
		SET
		m_recharge = 0,
		m_present=#{result2}
		WHERE
		user_id =
		#{userId}
	</update>


	<!--查询余额 -->
	<select id="queryAllMoney" resultType="com.stardai.manage.pojo.PayWallet">
		SELECT
		id,user_id,m_recharge,m_present
		FROM
		yjd_pay_wallet
		WHERE
		user_id = #{userId}
	</select>

	<!--查询个人的充值记录 -->
	<select id="queryAllIncome" resultType="com.stardai.manage.response.ResponseIncome">
		SELECT
		income_no,
		pay_pathway,
		pay_money,
		pay_create_time,
		type
		FROM
		yjd_pay_income
		WHERE
		user_id = #{userId}
		ORDER BY id DESC
		LIMIT #{page},
		#{pageSize}
	</select>

	<!--查询支出记录 -->
	<select id="queryAllOutcome" resultType="com.stardai.manage.response.ResponseOut">
		SELECT
		order_no,
		out_no,
		channel,
		amount,
		coupon_amount,
		create_time
		FROM
		yjd_pay_outcome
		WHERE
		user_id = #{userId}
		ORDER BY id DESC
		LIMIT #{page},
		#{pageSize}
	</select>

	<!-- 先去查询是否已经添加过这条数据 -->
	<select id="queryIncomeMessage" resultType="Integer">
		SELECT
		COUNT(*)
		FROM
		yjd_pay_income
		WHERE
		user_id = #{userId}
		AND
		income_no = #{incomeNo}
	</select>
	
	<!-- 充值人的钱包表中加上赠送的金额 -->
	<update id="updatePresentMoney">
		UPDATE yjd_pay_wallet
		SET
		m_present=(m_present + #{giveMoney})
		WHERE
		user_id = #{userId}
	</update>
	
	<!-- 根据充值的金额去查询赠送的金额-->
	<select id="queryAddMoney" resultType="Integer">
		SELECT
		add_money
		FROM
		yjd_pay_money
		WHERE
		start_money = #{amount}
	</select>

	<!--插入不同渠道消费的星币 来源-->
	<insert id="addMoneySource">
		INSERT INTO yjd_sum_money (
		order_no,
		recharge,
		present,
		channel,
		user_id,
		create_time
		)
		VALUES
		(
		#{order_no},
		#{recharge},
		#{present},
		#{channel},
		#{user_id},
		now()
		);
	</insert>

	<!--插入不同渠道消费的星币 来源-->
	<insert id="addMoneySource2">
		INSERT INTO yjd_sum_money (
		order_no,
		recharge,
		present,
		channel,
		channel_branch,
		user_id,
		create_time
		)
		VALUES
		(
		#{order_no},
		#{recharge},
		#{present},
		#{channel},
		#{channelBranch},
		#{user_id},
		now()
		);
	</insert>
	
	<!--把支出明细插入到支出信息表（使用优惠券） -->
	<insert id="addOutComeMoneyForCoupon">
		INSERT INTO yjd_pay_outcome (
		user_id,
		order_no,
		out_no,
		channel,
		amount,
		coupon_amount,
		create_time
		)
		VALUES
		(
		#{userId},
		#{orderNo},
		#{outNo},
		#{channel},
		#{amountYuan},
		#{couponAmount},
		now()
		);
	</insert>
	
	<!-- 用户注册，送优惠券的同时，在用户余额表里插入一条记录，方便后面充值，更新不会报错 -->
	<insert id="addPayRecord">
		INSERT INTO yjd_pay_wallet (
		user_id
		)
		VALUES
		(
		#{userId}
		);
	</insert>
	
	<!-- 查询当前时间是否有充值加赠活动-->
	<select id="queryExtraMoney" resultType="Integer">
		SELECT
		add_money
		FROM
		yjd_pay_money_temp
		WHERE
		start_money = #{amount}
		and #{currentTime} between begin_time and end_time 
		and event_switch = 0
	</select>

</mapper>