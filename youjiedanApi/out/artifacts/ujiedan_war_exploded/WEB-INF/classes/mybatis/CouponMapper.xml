<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace:命名空间 -->

<mapper namespace="com.stardai.manage.mapper.CouponMapper">

	<!-- 为新注册用户发放优惠券 -->
	<insert id="addCouponForNewUser" parameterType="java.util.List">
		INSERT INTO yjd_coupon_deduction
		(
		coupon_id,
		user_id,
		coupon_amount,
		effective_time,
		expiration_time,
		coupon_channel,
		coupon_form,
		coupon_type,
		create_time,
		update_time,
		create_user)
		VALUES
		<foreach collection="list" item="item" index="index"
			separator=",">
			(#{item.couponId},
			#{item.userId},
			#{item.couponAmount},
			#{item.effectiveTime},
			#{item.expirationTime},
			#{item.couponChannel},
			3,
			2,
			now(),
			now(),
			"system")
		</foreach>
	</insert>

	<!-- 获取注册赠送优惠券的有效时间,面额种类 -->
	<select id="getValidTimeForNewUser" resultType="java.util.HashMap">
		select
		amount,
		valid_time as validTime
		from
		yjd_coupon_type
		WHERE
		channel = '注册赠送'
	</select>


	<!-- 查看该用户当前可使用的优惠券张数 -->
	<select id="getCouponCounts" resultType="java.util.HashMap">
		SELECT
		(
		SELECT
		count(*)
		FROM
		yjd_coupon_deduction
		WHERE
		expiration_time >= NOW()
		AND is_deleted =
		0
		AND user_id = #{userId}
		) AS unused,
		(
		SELECT
		count(*)
		FROM
		yjd_coupon_deduction_used
		WHERE
		user_id = #{userId}
		) AS used,
		(
		SELECT
		count(*)
		FROM
		yjd_coupon_deduction
		WHERE
		expiration_time &lt; NOW()
		AND
		is_deleted = 0
		AND user_id = #{userId}
		) AS overdue
	</select>

	<!-- 根据前端传过来的状态获取优惠券列表（未使用和已过期的） -->
	<select id="queryCouponByStatus" resultType="com.stardai.manage.pojo.CouponInfo">
		select
		coupon_id as couponId,
		coupon_amount as couponAmount,
		coupon_discount as couponDiscount,
		coupon_fullreduction as
		couponFullreduction,
		effective_time as effectiveTime,
		expiration_time as
		expirationTime,
		coupon_type as couponType,
		coupon_form as couponForm
		from
		yjd_coupon_deduction
		WHERE
		user_id = #{userId}
		and is_deleted = 0
		<if test="couponStatus == 1">

			and expiration_time >= now()
		</if>
		<if test="couponStatus == 3">

			and expiration_time &lt; now()
		</if>

		ORDER BY create_time DESC,coupon_id DESC
		LIMIT #{page},
		#{pageSize}
	</select>

	<!-- 根据前端传过来的状态获取优惠券列表(已使用的优惠券从另一张表取) -->
	<select id="queryCouponUsedByStatus" resultType="com.stardai.manage.pojo.CouponInfo">
		select
		coupon_id
		as couponId,
		coupon_amount as couponAmount,
		coupon_discount as
		couponDiscount,
		coupon_fullreduction as couponFullreduction,
		effective_time as effectiveTime,
		expiration_time as expirationTime,
		coupon_type as couponType,
		coupon_form as couponForm
		from
		yjd_coupon_deduction_used
		WHERE
		user_id = #{userId}
		ORDER BY create_time
		DESC,coupon_id DESC
		LIMIT #{page},
		#{pageSize}
	</select>

	<!-- 根据优惠券id查询优惠券信息 -->
	<select id="queryCouponInfo" resultType="com.stardai.manage.request.RequestCouponInfo">
		select
		coupon_id as
		couponId,
		user_id as userId,
		coupon_amount as couponAmount,
		coupon_discount as couponDiscount,
		coupon_fullreduction as
		couponFullreduction,
		effective_time as effectiveTime,
		expiration_time as
		expirationTime,
		coupon_channel as couponChannel,
		coupon_form as
		couponForm,
		coupon_type as couponType,
		update_time as updateTime,
		create_user as createUser,
		coupon_reason as couponReason
		from
		yjd_coupon_deduction
		WHERE
		coupon_id =
		#{couponId}
	</select>


	<!-- 把已使用的优惠券放到另一张表里 -->
	<insert id="addCouponUsed" parameterType="com.stardai.manage.request.RequestCouponInfo">
		INSERT INTO
		yjd_coupon_deduction_used
		(
		coupon_id,
		user_id,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		effective_time,
		expiration_time,
		coupon_channel,
		coupon_form,
		coupon_type,
		create_time,coupon_create_time,coupon_create_user,coupon_reason)
		VALUES
		(#{couponId},#{userId},#{couponAmount},
		#{couponDiscount},#{couponFullreduction},
		#{effectiveTime},#{expirationTime},
		#{couponChannel},#{couponForm},#{couponType},now(),#{updateTime},#{createUser},#{couponReason})

	</insert>

	<!-- 把当前表里已使用的优惠券删除 -->
	<delete id="removeUsedCoupon">
		DELETE
		FROM
		yjd_coupon_deduction
		WHERE
		coupon_id =
		#{couponId}

	</delete>


	<!-- 查询当天有没有点击量 -->
	<select id="getAmountByDateAndStatus" resultType="Integer">
		select
		amount
		from
		yjd_coupon_count
		WHERE
		create_time = #{day}
		and
		coupon_category =
		#{couponStatus}
	</select>

	<!-- 插入最新点击量 -->
	<insert id="addClickAmount">
		INSERT INTO yjd_coupon_count
		(
		coupon_category,
		amount,
		create_time)
		VALUES
		(#{couponStatus},
		1,
		#{day})
	</insert>

	<!-- 更新点击量 -->
	<update id="updateClickAmount">
		UPDATE yjd_coupon_count
		SET
		amount = amount + 1
		WHERE
		create_time = #{day}
		and
		coupon_category = #{couponStatus}
	</update>


	<!-- 注册送优惠券发生异常的话，就把该用户的userId插入到一张表里 -->
	<insert id="addUnusualRecords">
		INSERT INTO yjd_coupon_unusual
		(
		user_id,
		create_time)
		VALUES
		(#{userId},
		now())
	</insert>



	<!-- 正在进行中的优惠券 -->
	<select id="getProcessingCouponList" resultType="com.stardai.manage.response.ResponseGetCoupon">
		select
		coupon_code,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		coupon_initial_count,
		coupon_count,
		coupon_form,
		coupon_type
		from
		yjd_get_coupon
		WHERE
		#{nowTime} between show_begin_time and
		show_end_time
		and #{nowTime} between get_begin_time and get_end_time
		and is_deleted = 0
		and approve_status = 0
		and coupon_count > 0
		ORDER BY
		get_begin_time,coupon_code
		
	</select>

	<!-- 未开始的优惠券列表 -->
	<select id="getBerforeTimeCouponList" resultType="com.stardai.manage.response.ResponseGetCoupon">
		select
		coupon_code,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		get_begin_time,
		coupon_form,
		coupon_type
		from
		yjd_get_coupon
		WHERE
		#{nowTime} between show_begin_time and show_end_time
		and #{nowTime}
		&lt; get_begin_time
		and is_deleted = 0
		and approve_status = 0
		ORDER BY
		get_begin_time,coupon_code
		
	</select>

	<!--已结束的优惠券列表 -->
	<select id="getEndCouponList" resultType="com.stardai.manage.response.ResponseGetCoupon">
		select
		coupon_code,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		coupon_form,
		coupon_type
		from
		yjd_get_coupon
		WHERE
		#{nowTime} between show_begin_time
		and show_end_time
		and is_deleted = 0
		and (#{nowTime} > get_end_time
		or
		approve_status = 1
		or
		0 >= coupon_count)
		ORDER BY get_begin_time,coupon_code
		
	</select>


	<!-- 查询此人今天有没有领取过此种优惠券 -->
	<select id="queryIsGetCouponToday" resultType="String">
		select
		coupon_code
		from
		yjd_user_coupon
		WHERE
		user_id = #{userId}
		and get_type = 1
		and
		coupon_code =
		#{couponCode}
		and
		create_date = substr(now(),1,10)
		order by create_datetime desc
		limit 1
	</select>




	<!-- 用户领过券之后，把领券信息插入到数据库表里 -->
	<insert id="addCouponForUserAutomaticly">
		INSERT INTO
		yjd_user_coupon
		(
		user_id,
		coupon_code,
		coupon_id,
		create_date,
		create_datetime,
		get_type
		)
		VALUES
		(#{userId},
		#{couponCode},
		#{couponId},
		now(),
		now(),
		#{getType}
		)
	</insert>

	<!-- 把领取的优惠券插入优惠券表里 -->
	<insert id="addCouponForGettingUser">
		INSERT INTO
		yjd_coupon_deduction
		(
		coupon_id,
		user_id,
		coupon_amount,
		coupon_discount,
		coupon_fullreduction,
		effective_time,
		expiration_time,
		coupon_channel,
		coupon_form,
		coupon_type,
		create_time,
		update_time,
		create_user)
		VALUES
		(#{couponId},
		#{userId},
		#{couponAmount},
		#{couponDiscount},
		#{couponFullreduction},
		#{effectiveTime},
		#{expirationTime},
		#{couponChannel},
		#{couponForm},
		#{couponType},
		now(),
		now(),
		"system")

	</insert>
	
	<!-- 根据优惠券的标识符查询优惠券的具体信息 -->
	<select id="getCouponInfoByCode" resultType="com.stardai.manage.request.RequestCouponForNewUser">
		select
		coupon_amount,
		coupon_count,
		coupon_validity,
		effective_time,
		expiration_time,
		timing_type
		from
		yjd_get_coupon
		WHERE	
		coupon_code =
		#{couponCode}
		and
		is_deleted = 0
		and
		approve_status = 0
	</select>
	
	<!-- 用户领取优惠券之后，数量减1 -->
	<update id="setCouponCount">
		UPDATE yjd_get_coupon
		SET
		coupon_count = coupon_count - 1
		WHERE
		coupon_code = #{couponCode}
	</update>
	
	
	<!-- 根据优惠券码获取优惠券的剩余数量 -->
	<select id="getCouponCountByCode" resultType="Integer">
		select
		coupon_count
		from
		yjd_get_coupon
		WHERE
		coupon_code =
		#{couponCode}
	</select>
	
	<!-- 查询此人有没有领取过此种优惠券 -->
	<select id="queryIsGetCouponBefore" resultType="String">
		select
		coupon_code
		from
		yjd_user_coupon
		WHERE
		user_id = #{userId}
		and get_type = 1
		and coupon_code = #{couponCode}
		order by create_datetime desc
		limit 1
	</select>
	

</mapper>